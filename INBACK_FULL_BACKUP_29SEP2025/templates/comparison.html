{% extends "base.html" %}

{% block title %}–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ | InBack{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h1>
                    <p class="text-gray-600">–°—Ä–∞–≤–Ω–∏—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º</p>
                </div>
                <button onclick="clearAllComparisons()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-trash mr-2"></i>–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                </button>
            </div>
        </div>

        <!-- Comparison Tabs -->
        <div class="flex space-x-1 mb-8">
            <button onclick="switchTab('properties')" id="tab-properties" class="comparison-tab active px-6 py-3 rounded-lg text-lg font-medium bg-[#0088CC] text-white">
                –ö–≤–∞—Ä—Ç–∏—Ä—ã (<span id="properties-count">0</span>)
            </button>
            <button onclick="switchTab('complexes')" id="tab-complexes" class="comparison-tab px-6 py-3 rounded-lg text-lg font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">
                –ñ–ö (<span id="complexes-count">0</span>)
            </button>
        </div>

        <!-- Properties Comparison -->
        <div id="properties-comparison" class="comparison-content">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div id="properties-grid" class="overflow-x-auto">
                    <!-- Properties comparison table will be loaded here -->
                    <div class="text-center py-16">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complexes Comparison -->
        <div id="complexes-comparison" class="comparison-content hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div id="complexes-grid" class="overflow-x-auto">
                    <!-- Complexes comparison table will be loaded here -->
                    <div class="text-center py-16">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ñ–ö...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-12">
            <div class="text-center">
                <div class="mx-auto h-24 w-24 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 flex items-center justify-center mb-6">
                    <i class="fas fa-balance-scale text-[#0088CC] text-3xl"></i>
                </div>
                <h3 class="text-xl font-medium text-gray-900 mb-2">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</h3>
                <p class="text-gray-600 mb-6">–î–æ–±–∞–≤—å—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏–ª–∏ –ñ–ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</p>
                <a href="{{ url_for('properties') }}" 
                   class="bg-[#0088CC] hover:bg-[#006699] text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-search mr-2"></i>–ù–∞–π—Ç–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let propertiesData = [];
let complexesData = [];
let isDataLoaded = false;
let isDataLoading = false;

// Load data on page load
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Comparison page loaded');
    
    // Clear old invalid complex IDs (1,2,3) if they exist
    await cleanupOldComparisonData();
    
    // Check localStorage immediately - use all formats
    let propertiesItems = JSON.parse(localStorage.getItem('comparisons') || '[]');
    if (propertiesItems.length === 0) {
        const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
        propertiesItems = comparisonData.properties || [];
    }
    if (propertiesItems.length === 0) {
        propertiesItems = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
    }
    const complexesItems = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
    console.log('Properties in comparison:', propertiesItems);
    console.log('Complexes in comparison:', complexesItems);
    
    updateCounts();
    
    // Load data first, then load comparisons
    await loadData();
});

// Function to cleanup old comparison data with invalid IDs
async function cleanupOldComparisonData() {
    try {
        const complexesItems = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        const validComplexes = [];
        
        // Check each complex ID
        for (const complexId of complexesItems) {
            try {
                const response = await fetch(`/api/complex/${complexId}`);
                if (response.ok) {
                    validComplexes.push(complexId);
                } else {
                    console.log(`Removing invalid complex ID ${complexId} from comparison`);
                }
            } catch (error) {
                console.log(`Removing invalid complex ID ${complexId} from comparison`);
            }
        }
        
        // Update localStorage with only valid IDs
        if (validComplexes.length !== complexesItems.length) {
            localStorage.setItem('comparison_complexes', JSON.stringify(validComplexes));
            console.log('Cleaned up comparison data:', validComplexes);
        }
    } catch (error) {
        console.error('Error cleaning up comparison data:', error);
    }
}

async function loadData() {
    if (isDataLoading) {
        console.log('Data loading already in progress, waiting...');
        return;
    }
    
    isDataLoading = true;
    
    try {
        console.log('üîÑ Starting data loading...');
        
        // Load properties using API endpoint that's confirmed working
        const propertiesResponse = await fetch('/api/properties');
        const propertiesResponseData = await propertiesResponse.json();
        propertiesData = propertiesResponseData.properties || propertiesResponseData;
        
        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é - –≤ –Ω–∏—Ö –µ—Å—Ç—å floors, completion_date!
        try {
            console.log('üîß –ü–†–ò–û–†–ò–¢–ï–¢: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON —Ñ–∞–π–ª–∞ —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏');
            const fallbackResponse = await fetch('/static/data/residential_complexes_expanded.json');
            const fallbackData = await fallbackResponse.json();
            complexesData = Array.isArray(fallbackData) ? fallbackData : (fallbackData.complexes || fallbackData);
            console.log('‚úÖ Complexes loaded from JSON file with FULL DATA:', complexesData.length, 'complexes');
            console.log('üîç Sample complex data:', complexesData[0] ? {
                completion_date: complexesData[0].completion_date,
                floors_min: complexesData[0].floors_min, 
                floors_max: complexesData[0].floors_max,
                apartments_count: complexesData[0].apartments_count
            } : 'No complexes');
            
            // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            window.complexesData = complexesData;
            if (!window.lastComparisonData) window.lastComparisonData = {};
            window.lastComparisonData.complexes = complexesData;
        } catch (error) {
            console.error('‚ùå JSON —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, fallback –∫ API:', error);
            // Fallback –∫ API —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
            const complexesResponse = await fetch('/api/residential-complexes');
            const complexesResponseData = await complexesResponse.json();
            complexesData = complexesResponseData.complexes || complexesResponseData;
            console.warn('‚ö†Ô∏è Using API data (may have incomplete info)');
        }
        
        console.log('‚úÖ Properties data loaded:', propertiesData.length, 'properties');
        console.log('‚úÖ Complexes data loaded:', complexesData.length, 'complexes');
        
        // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º properties –¥–∞–Ω–Ω—ã–µ –≤ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        window.propertiesData = propertiesData;
        if (!window.lastComparisonData) window.lastComparisonData = {};
        window.lastComparisonData.properties = propertiesData;
        
        // ‚úÖ RACE CONDITION FIX: Mark data as loaded BEFORE calling loadComparisons
        isDataLoaded = true;
        console.log('‚úÖ Data loading completed, isDataLoaded = true');
        
        // Now reload comparisons with actual data
        loadComparisons();
        
    } catch (error) {
        console.error('‚ùå Error loading data:', error);
        // Initialize empty data and still try to load comparisons
        propertiesData = [];
        complexesData = [];
        console.error('All data loading attempts failed, using empty arrays');
        isDataLoaded = false; // Mark as failed
        loadComparisons();
    } finally {
        isDataLoading = false;
    }
}

function loadComparisons() {
    loadComparison('properties');
    loadComparison('complexes');
}

function switchTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.comparison-tab').forEach(btn => {
        btn.classList.remove('active', 'bg-[#0088CC]', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-600');
    });
    
    document.getElementById(`tab-${tab}`).classList.remove('bg-gray-100', 'text-gray-600');
    document.getElementById(`tab-${tab}`).classList.add('active', 'bg-[#0088CC]', 'text-white');
    
    // Switch content
    document.querySelectorAll('.comparison-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`${tab}-comparison`).classList.remove('hidden');
    
    loadComparison(tab);
}

// This function was removed - using the new API-based loadComparison function below

async function buildPropertiesComparison(propertyIds, grid) {
    console.log('üîç Building comparison for property IDs:', propertyIds);
    console.log('üîç Data loading state - isDataLoaded:', isDataLoaded, 'isDataLoading:', isDataLoading);
    console.log('üîç Available properties data:', Array.isArray(propertiesData) ? propertiesData.length + ' properties' : 'Not an array: ' + typeof propertiesData);
    
    // ‚úÖ RACE CONDITION FIX: Check if data is loaded, if not wait for it or show loading
    if (!isDataLoaded && !isDataLoading) {
        console.log('‚è≥ Data not loaded yet, starting data loading...');
        showLoadingState(grid, 'properties');
        await loadData();
        if (!isDataLoaded) {
            console.error('‚ùå Failed to load data, showing empty state');
            showEmptyState('properties');
            return;
        }
    } else if (isDataLoading) {
        console.log('‚è≥ Data loading in progress, showing loading state...');
        showLoadingState(grid, 'properties');
        // Wait for data loading to complete
        let attempts = 0;
        while (isDataLoading && attempts < 50) { // Max 5 seconds
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }
        if (!isDataLoaded) {
            console.error('‚ùå Data loading timeout, showing empty state');
            showEmptyState('properties');
            return;
        }
    }
    
    // ‚úÖ Additional check: Ensure we have actual data
    if (!Array.isArray(propertiesData) || propertiesData.length === 0) {
        console.error('‚ùå propertiesData is empty or invalid, attempting to reload...');
        try {
            await loadData();
            if (!Array.isArray(propertiesData) || propertiesData.length === 0) {
                console.error('‚ùå Still no data after reload, showing empty state');
                showEmptyState('properties');
                return;
            }
        } catch (error) {
            console.error('‚ùå Error reloading data:', error);
            showEmptyState('properties');
            return;
        }
    }
    
    console.log('‚úÖ Data validation passed, building comparison with', propertiesData.length, 'properties available');
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º enriched –¥–∞–Ω–Ω—ã–µ –∏–∑ API /api/comparison/load –≤–º–µ—Å—Ç–æ /api/properties
    const comparisonApiData = window.lastComparisonData?.properties || [];
    console.log('‚úÖ Using comparison API data:', comparisonApiData.length, 'properties with completion_date');
    
    // ‚úÖ –ù–û–í–û–ï: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏–∑ API
    function getPropertyImage(property) {
        if (!property) return null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º photos –∏–∑ API
        if (property.photos) {
            try {
                // –ï—Å–ª–∏ photos - —Å—Ç—Ä–æ–∫–∞ JSON, –ø–∞—Ä—Å–∏–º –µ—ë
                if (typeof property.photos === 'string') {
                    const photosArray = JSON.parse(property.photos);
                    if (Array.isArray(photosArray) && photosArray.length > 0) {
                        return photosArray[0];
                    }
                }
                // –ï—Å–ª–∏ photos —É–∂–µ –º–∞—Å—Å–∏–≤
                else if (Array.isArray(property.photos) && property.photos.length > 0) {
                    return property.photos[0];
                }
            } catch (e) {
                console.log('Error parsing photos:', e);
            }
        }
        return null;
    }

    const comparisonProperties = propertyIds.map(id => {
        // ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ò—â–µ–º –≤ API comparison data (—Å–æ–¥–µ—Ä–∂–∏—Ç completion_date!)
        const apiProperty = comparisonApiData.find(p => p.property_id == id);
        
        // ‚úÖ FALLBACK: –ò—â–µ–º –≤ –æ–±—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö properties —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ comparison API
        const property = apiProperty || (Array.isArray(propertiesData) ? propertiesData.find(p => p.id == id) : null);
        
        console.log(`Looking for property ID ${id}:`, apiProperty ? 'Found in comparison API' : (property ? 'Found in general data' : 'Not found'));
        
        if (property || apiProperty) {
            const actualProperty = apiProperty || property;
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º completion_date –∏–∑ API comparison data
            const completionDate = apiProperty?.completion_date || 
                                  (property?.completion_date && property.completion_date.trim()) || 
                                  '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            
            // Find residential complex info  
            const complex = Array.isArray(complexesData) ? complexesData.find(c => c.id == actualProperty.residential_complex_id) : null;
            let complexName = apiProperty?.complex_name || complex?.name || actualProperty.complex_name || actualProperty.residential_complex || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            
            // Fix duplicate "–ñ–ö –ñ–ö" issue
            complexName = complexName
                .replace(/^–ñ–ö\s+–ñ–ö\s+/, '–ñ–ö ')  // Remove duplicate "–ñ–ö –ñ–ö"
                .replace(/^–ñ–ö\s+¬´?/, '–ñ–ö ¬´')     // Normalize quotes
                .replace(/¬´?$/, '¬ª');            // Ensure closing quote
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API /api/comparison/load
            const rooms = apiProperty?.rooms ?? actualProperty?.rooms;
            const area = apiProperty?.area ?? actualProperty?.area;
            const price = apiProperty?.property_price ?? actualProperty?.price;
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–ú property_name –∏–∑ API (—Å–æ–¥–µ—Ä–∂–∏—Ç "-–∫–æ–º–Ω")!
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π title –∏–∑ rooms + area
            let title;
            if (rooms !== undefined && rooms !== null) {
                const roomsText = rooms === 0 ? '–°—Ç—É–¥–∏—è' : `${rooms}-–∫–æ–º–Ω`;
                const areaText = area ? `, ${area} –º¬≤` : '';
                title = `${roomsText}${areaText}`;
            } else {
                // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å rooms –∏–∑ actualProperty  
                const propRooms = actualProperty?.rooms ?? actualProperty?.room_count ?? actualProperty?.object_room;
                const propArea = actualProperty?.area ?? actualProperty?.total_area;
                
                if (propRooms !== undefined && propRooms !== null) {
                    const roomsText = propRooms === 0 ? '–°—Ç—É–¥–∏—è' : `${propRooms}-–∫–æ–º–Ω`;
                    const areaText = propArea ? `, ${propArea} –º¬≤` : '';
                    title = `${roomsText}${areaText}`;
                } else {
                    title = '–ö–≤–∞—Ä—Ç–∏—Ä–∞';
                }
            }
            
            const cashbackPercent = '3%';
            const cashbackAmount = price ? Math.round(price * 0.03) : 0;
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ü–µ–Ω—ã
            const finalPrice = price || actualProperty?.property_price || actualProperty?.price || 0;
            const finalArea = area || actualProperty?.total_area || actualProperty?.area || 0;
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π district –∏–∑ actualProperty
            const district = actualProperty?.district || actualProperty?.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            
            return {
                id: apiProperty?.property_id || actualProperty?.id,
                title: title,
                complex: complexName,
                price: finalPrice,
                area: finalArea,
                floor: apiProperty?.object_min_floor ?? actualProperty?.object_min_floor ?? actualProperty?.floor ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                total_floors: apiProperty?.object_max_floor ?? actualProperty?.object_max_floor ?? actualProperty?.total_floors ?? '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                district: district,
                cashback: finalPrice ? Math.round(finalPrice * 0.03) : 0,
                cashback_percent: cashbackPercent,
                developer: apiProperty?.developer_name || actualProperty?.developer_name || actualProperty?.developer || (complex && (complex.developer_name || complex.developer)) || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                finishing: apiProperty?.finishing || actualProperty?.renovation_display_name || actualProperty?.renovation_type || actualProperty?.finishing || actualProperty?.finish_type || '–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏',
                completion_date: completionDate,
                has_balcony: actualProperty?.has_balcony ? '–î–∞' : '–ù–µ—Ç',
                mortgage_available: actualProperty?.mortgage_available ? '–î–∞' : '–ù–µ—Ç',
                price_per_sqm: finalPrice && finalArea ? Math.round(finalPrice / finalArea) : '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                image: getPropertyImage(actualProperty) || actualProperty?.main_image || actualProperty?.image || (complex && (complex.photo || complex.image)) || '/static/images/no-image.jpg'
            };
        }
        
        return {
            id: id,
            title: `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${id}`,
            complex: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            price: 0,
            area: 0,
            floor: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            total_floors: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            district: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            cashback: 0,
            cashback_percent: '0%',
            developer: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            finishing: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            completion_date: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            has_balcony: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            mortgage_available: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            price_per_sqm: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
            image: '/static/images/no-image.jpg'
        };
    });
    
    // Create table-based comparison like complex-comparison page
    let tableHTML = `
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 w-48">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th>
                        ${comparisonProperties.map((property, index) => `
                            <th class="px-6 py-4 text-center text-sm font-medium text-gray-500 min-w-80">
                                <div class="flex flex-col items-center">
                                    <span class="font-semibold text-gray-900 mb-2">${property.title}</span>
                                    <button onclick="removeFromComparisonPage('properties', '${property.id}', this)" 
                                            class="text-red-500 hover:text-red-700 text-sm bg-red-50 hover:bg-red-100 px-3 py-1 rounded-full transition-colors">
                                        <i class="fas fa-times mr-1"></i>–£–±—Ä–∞—Ç—å
                                    </button>
                                </div>
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <!-- Images Row -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-gray-900">–§–æ—Ç–æ</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">
                                <img src="${property.image}" 
                                     alt="${property.title}"
                                     class="w-32 h-24 object-cover rounded-lg mx-auto">
                            </td>
                        `).join('')}
                    </tr>
                    
                    <!-- Property Name -->
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–ö–≤–∞—Ä—Ç–∏—Ä–∞</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center font-semibold">${property.title}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- –ñ–ö -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-gray-900">–ñ–ö</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">${property.complex}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- Price -->
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–¶–µ–Ω–∞</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center text-lg font-bold text-[#0088CC]">
                                ${property.price ? property.price.toLocaleString() + ' ‚ÇΩ' : '–ü–æ –∑–∞–ø—Ä–æ—Å—É'}
                            </td>
                        `).join('')}
                    </tr>
                    
                    <!-- Cashback -->
                    <tr class="bg-green-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–ö–µ—à–±–µ–∫</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center font-bold text-green-600">
                                +${property.cashback.toLocaleString()} ‚ÇΩ (${property.cashback_percent})
                            </td>
                        `).join('')}
                    </tr>
                    
                    <!-- Area -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-gray-900">–ü–ª–æ—â–∞–¥—å</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center text-lg font-semibold">
                                ${property.area ? property.area + ' –º¬≤' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                            </td>
                        `).join('')}
                    </tr>
                    
                    <!-- Price per sqm -->
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–¶–µ–Ω–∞ –∑–∞ –º¬≤</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center font-semibold">
                                ${property.price_per_sqm !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' ? property.price_per_sqm.toLocaleString() + ' ‚ÇΩ/–º¬≤' : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </td>
                        `).join('')}
                    </tr>
                    
                    <!-- Floor -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-gray-900">–≠—Ç–∞–∂</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">
                                ${property.floor}${property.total_floors !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' ? '/' + property.total_floors : ''}
                            </td>
                        `).join('')}
                    </tr>
                    
                    <!-- District -->
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–†–∞–π–æ–Ω</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">${property.district}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- Developer -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-gray-900">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">${property.developer}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- Finishing -->
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–û—Ç–¥–µ–ª–∫–∞</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">${property.finishing}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- Completion Date -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-gray-900">–°—Ä–æ–∫ —Å–¥–∞—á–∏</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">${property.completion_date}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- Balcony -->
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–ë–∞–ª–∫–æ–Ω</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">${property.has_balcony}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- Mortgage -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-gray-900">–ò–ø–æ—Ç–µ–∫–∞</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">${property.mortgage_available}</td>
                        `).join('')}
                    </tr>
                    
                    <!-- Action Buttons -->
                    <tr class="bg-blue-50">
                        <td class="px-6 py-4 font-medium text-gray-900">–î–µ–π—Å—Ç–≤–∏—è</td>
                        ${comparisonProperties.map(property => `
                            <td class="px-6 py-4 text-center">
                                <a href="/object/${property.id}" 
                                   class="inline-flex items-center px-4 py-2 bg-[#0088CC] hover:bg-[#006699] text-white rounded-lg font-medium transition-colors">
                                    <i class="fas fa-eye mr-2"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                </a>
                            </td>
                        `).join('')}
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    
    grid.innerHTML = tableHTML;
}

async function buildComplexesComparison(complexIds, grid) {
    console.log('üö® –°–¢–ê–†–ê–Ø –§–£–ù–ö–¶–ò–Ø buildComplexesComparison –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è:', complexIds);
    console.warn('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback —Ñ—É–Ω–∫—Ü–∏—è –≤–º–µ—Å—Ç–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Å API –¥–∞–Ω–Ω—ã–º–∏');
    
    const comparisonComplexes = [];
    
    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ API
    console.log('üîß –°–¢–ê–†–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ò—â–µ–º –∫–æ–º–ø–ª–µ–∫—Å—ã –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON —Ñ–∞–π–ª–∞');
    
    for (const id of complexIds) {
        try {
            // –ò—â–µ–º –∫–æ–º–ø–ª–µ–∫—Å –≤ —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            let complex = null;
            if (window.complexesData && Array.isArray(window.complexesData)) {
                complex = window.complexesData.find(c => c.id == id || c.complex_id == id);
            }
            
            if (!complex) {
                console.error(`Complex ${id} not found in JSON data`);
                comparisonComplexes.push({
                    id: id,
                    name: `–ñ–ö ${id} (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ)`,
                    developer: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    district: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    completion_date: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    price_from: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    price_to: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    building_class: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    buildings_count: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    apartments_count: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    floors_min: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    floors_max: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    construction_technology: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    parking: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                    cashback_percent: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'
                });
                continue;
            }
            
            console.log(`‚úÖ Found complex ${id} in JSON data:`, {
                completion_date: complex.completion_date,
                floors_min: complex.floors_min,
                floors_max: complex.floors_max,
                apartments_count: complex.apartments_count
            });
            
            comparisonComplexes.push({
                id: complex.id,
                name: complex.name || `–ñ–ö ${complex.id}`,
                developer: complex.developer || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                district: complex.district || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', 
                completion_date: complex.completion_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // ‚úÖ –¢–µ–ø–µ—Ä—å –∏–∑ —Ñ–∞–π–ª–∞!
                price_from: complex.price_from || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                price_to: complex.price_to || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                building_class: complex.building_class || complex.class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                buildings_count: complex.buildings_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                apartments_count: complex.apartments_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // ‚úÖ –¢–µ–ø–µ—Ä—å –∏–∑ —Ñ–∞–π–ª–∞!
                floors_min: complex.floors_min || complex.object_min_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ API!
                floors_max: complex.floors_max || complex.object_max_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ API!
                construction_technology: complex.construction_technology || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                parking: complex.parking || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                cashback_percent: complex.cashback_percent || complex.cashback_rate || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
            });
            
        } catch (error) {
            console.error(`Error loading complex ${id}:`, error);
            comparisonComplexes.push({
                id: id,
                name: `–ñ–ö ${id} (–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏)`,
                developer: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                district: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                completion_date: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                price_from: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                price_to: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                building_class: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                buildings_count: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                apartments_count: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                floors_min: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                floors_max: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                construction_technology: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                parking: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                cashback_percent: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'
            });
        }
    }
    
    let tableHTML = `
        <table class="min-w-full bg-white">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                    ${comparisonComplexes.map(complex => `
                        <th class="px-6 py-4 text-center text-sm font-medium text-gray-900">
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-gradient-to-br from-green-100 to-blue-100 rounded-lg flex items-center justify-center mb-3">
                                    <i class="fas fa-building text-green-600 text-xl"></i>
                                </div>
                                <span class="font-semibold text-gray-900 mb-2">${complex.name || `–ñ–ö ${complex.id}`}</span>
                                <button onclick="removeFromComparisonPage('complexes', '${complex.id}', this)" 
                                        class="text-red-500 hover:text-red-700 text-sm bg-red-50 hover:bg-gray-100 px-3 py-1 rounded-full transition-colors">
                                    <i class="fas fa-times mr-1"></i>–£–±—Ä–∞—Ç—å
                                </button>
                            </div>
                        </th>
                    `).join('')}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.developer || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–†–∞–π–æ–Ω</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.district || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö–ª–∞—Å—Å –∂–∏–ª—å—è</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.building_class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–°—Ä–æ–∫ —Å–¥–∞—á–∏</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.completion_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–¶–µ–Ω–∞ –æ—Ç</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <span class="text-xl font-bold text-green-600">
                                ${complex.price_from ? (typeof complex.price_from === 'number' ? complex.price_from.toLocaleString() + ' ‚ÇΩ' : complex.price_from) : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </span>
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–¶–µ–Ω–∞ –¥–æ</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <span class="text-xl font-bold text-green-600">
                                ${complex.price_to ? (typeof complex.price_to === 'number' ? complex.price_to.toLocaleString() + ' ‚ÇΩ' : complex.price_to) : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </span>
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–ø—É—Å–æ–≤</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.buildings_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.apartments_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.floors_min && complex.floors_max ? 
                                (complex.floors_min === complex.floors_max ? 
                                    complex.floors_min + ' —ç—Ç.' : 
                                    complex.floors_min + '-' + complex.floors_max + ' —ç—Ç.') : 
                                '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.construction_technology || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ü–∞—Ä–∫–∏–Ω–≥</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.parking || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö—ç—à–±–µ–∫ %</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <span class="text-xl font-bold text-[#0088CC]">
                                ${complex.cashback_percent ? complex.cashback_percent + '%' : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </span>
                        </td>
                    `).join('')}
                </tr>
            </tbody>
        </table>
    `;
    
    grid.innerHTML = tableHTML;
}

// ‚úÖ –ù–û–í–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: Cache bust v1758466800 - Fixed mapping
function buildComplexesComparisonWithDataFixed(complexesData, grid) {
    console.log('üéØüéØüéØ –í–ï–†–°–ò–Ø 3.0 –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø! –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï MAPPING! Real data:', complexesData);
    
    const comparisonComplexes = complexesData.map(complex => {
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π API –æ—Ç–≤–µ—Ç–∞
        return {
            id: complex.id || complex.complex_id,
            name: complex.name || complex.complex_name || `–ñ–ö ${complex.id || complex.complex_id}`,
            developer: complex.developer || complex.developer_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            district: complex.district || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            completion_date: complex.completion_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            price_from: complex.price_from || complex.min_price || 0,
            price_to: complex.price_to || complex.max_price || 0,
            building_class: complex.building_class || complex.complex_class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            buildings_count: complex.buildings_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            apartments_count: complex.apartments_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            floors_min: complex.floors_min || complex.object_min_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ API!
            floors_max: complex.floors_max || complex.object_max_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ API!
            construction_technology: '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // –ù–µ—Ç –≤ API
            parking: '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // –ù–µ—Ç –≤ API
            cashback_percent: 5.0, // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—ç—à–±–µ–∫
            image: complex.image || complex.photo || 'https://images.unsplash.com/photo-1600607687920-4e2a09cf159d?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=200&q=80' // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –§–æ—Ç–æ –ñ–ö
        };
    });
    
    console.log('üèóÔ∏è Transformed complexes for comparison:', comparisonComplexes);
    
    let tableHTML = `
        <table class="min-w-full bg-white">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                    ${comparisonComplexes.map(complex => `
                        <th class="px-6 py-4 text-center text-sm font-medium text-gray-900">
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-gradient-to-br from-green-100 to-blue-100 rounded-lg flex items-center justify-center mb-3">
                                    <i class="fas fa-building text-green-600 text-xl"></i>
                                </div>
                                <span class="font-semibold text-gray-900 mb-2">${complex.name}</span>
                                <button onclick="removeFromComparisonPage('complexes', '${complex.id}', this)" 
                                        class="text-red-500 hover:text-red-700 text-sm bg-red-50 hover:bg-gray-100 px-3 py-1 rounded-full transition-colors">
                                    <i class="fas fa-times mr-1"></i>–£–±—Ä–∞—Ç—å
                                </button>
                            </div>
                        </th>
                    `).join('')}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <!-- ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –°—Ç—Ä–æ–∫–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏ –ñ–ö -->
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–§–æ—Ç–æ</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <img src="${complex.image}" 
                                 alt="${complex.name}" 
                                 class="w-48 h-32 object-cover rounded-lg mx-auto shadow-sm hover:shadow-md transition-shadow" 
                                 onerror="this.src='https://images.unsplash.com/photo-1600607687920-4e2a09cf159d?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=200&q=80'">
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.developer}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–†–∞–π–æ–Ω</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.district}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö–ª–∞—Å—Å –∂–∏–ª—å—è</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.building_class}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–°—Ä–æ–∫ —Å–¥–∞—á–∏</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.completion_date}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–¶–µ–Ω–∞ –æ—Ç</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <span class="text-xl font-bold text-green-600">
                                ${complex.price_from && complex.price_from > 0 ? complex.price_from.toLocaleString() + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </span>
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–¶–µ–Ω–∞ –¥–æ</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <span class="text-xl font-bold text-green-600">
                                ${complex.price_to && complex.price_to > 0 ? complex.price_to.toLocaleString() + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </span>
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–ø—É—Å–æ–≤</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.buildings_count}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.apartments_count}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.floors_min && complex.floors_max ? 
                                (complex.floors_min === complex.floors_max ? 
                                    complex.floors_min + ' —ç—Ç.' : 
                                    complex.floors_min + '-' + complex.floors_max + ' —ç—Ç.') : 
                                '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.construction_technology}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ü–∞—Ä–∫–∏–Ω–≥</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center font-medium">
                            ${complex.parking}
                        </td>
                    `).join('')}
                </tr>
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold text-gray-900">–ö—ç—à–±–µ–∫ %</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <span class="text-xl font-bold text-blue-600">
                                ${complex.cashback_percent}%
                            </span>
                        </td>
                    `).join('')}
                </tr>
                
                <!-- Action Buttons -->
                <tr class="bg-blue-50">
                    <td class="px-6 py-4 font-medium text-gray-900">–î–µ–π—Å—Ç–≤–∏—è</td>
                    ${comparisonComplexes.map(complex => `
                        <td class="px-6 py-4 text-center">
                            <a href="/residential-complex/${complex.id}" 
                               class="inline-flex items-center px-4 py-2 bg-[#0088CC] hover:bg-[#006699] text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-eye mr-2"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </a>
                        </td>
                    `).join('')}
                </tr>
            </tbody>
        </table>
    `;
    
    grid.innerHTML = tableHTML;
}

function showEmptyState(type) {
    const grid = document.getElementById(`${type}-grid`);
    grid.innerHTML = `
        <div class="text-center py-16">
            <div class="mx-auto h-20 w-20 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 flex items-center justify-center mb-6">
                <i class="fas fa-${type === 'properties' ? 'balance-scale' : 'building'} text-gray-400 text-2xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç ${type === 'properties' ? '–∫–≤–∞—Ä—Ç–∏—Ä' : '–ñ–ö'} –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</h3>
            <p class="text-gray-600 mb-6">–î–æ–±–∞–≤—å—Ç–µ ${type === 'properties' ? '–∫–≤–∞—Ä—Ç–∏—Ä—ã' : '–ñ–ö'} –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
            <a href="${type === 'properties' ? '/properties' : '/complexes'}" 
               class="bg-[#0088CC] hover:bg-[#006699] text-white px-6 py-3 rounded-lg font-medium transition-colors">
                <i class="fas fa-search mr-2"></i>–ù–∞–π—Ç–∏ ${type === 'properties' ? '–∫–≤–∞—Ä—Ç–∏—Ä—ã' : '–ñ–ö'}
            </a>
        </div>
    `;
}

async function removeFromComparisonPage(type, id, buttonElement) {
    console.log(`üóëÔ∏è Removing ${id} from ${type} comparison`);
    
    try {
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
        const endpoint = type === 'properties' 
            ? '/api/comparison/remove-property' 
            : '/api/comparison/remove-complex';
        
        const response = await fetch(endpoint, {
            method: 'DELETE', // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º DELETE –∫–∞–∫ —Ç—Ä–µ–±—É—é—Ç API endpoints
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                [type === 'properties' ? 'property_id' : 'complex_id']: id
            })
        });
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º response.ok –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log(`üóëÔ∏è API response:`, result);
        
        if (result.success) {
            console.log(`‚úÖ Successfully removed ${id} from ${type} via API`);
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–æ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π button element
            if (buttonElement) {
                const headerCell = buttonElement.closest('th');
                if (headerCell) {
                    const columnIndex = Array.from(headerCell.parentNode.children).indexOf(headerCell);
                    const table = headerCell.closest('table');
                    if (table && columnIndex > 0) {
                        table.querySelectorAll('tr').forEach(row => {
                            if (row.children[columnIndex]) {
                                row.children[columnIndex].remove();
                            }
                        });
                        console.log(`‚úÖ Removed column ${columnIndex} from table`);
                    }
                }
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ localStorage - —É–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö –∫–ª—é—á–µ–π
            cleanupLocalStorage(type, id);
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–∑ API –ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
            await loadComparison(type);
            updateCounts();
            
            // Update comparison count in header if exists
            if (window.comparisonManager) {
                window.comparisonManager.updateComparisonUI();
            }
            
            showNotification(`–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è`, 'success');
            
            // Check if both comparisons are empty
            checkAndShowEmptyState();
            
        } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
        }
        
    } catch (error) {
        console.error(`‚ùå Error removing ${id} from ${type}:`, error);
        
        // ‚úÖ Fallback: —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ localStorage –ø—Ä–∏ –æ—à–∏–±–∫–µ API
        console.log(`Using localStorage fallback for removing ${id}`);
        
        // ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM –ø—Ä–∏ –æ—à–∏–±–∫–µ API —Ç–æ–∂–µ
        if (buttonElement) {
            const headerCell = buttonElement.closest('th');
            if (headerCell) {
                const columnIndex = Array.from(headerCell.parentNode.children).indexOf(headerCell);
                const table = headerCell.closest('table');
                if (table && columnIndex > 0) {
                    table.querySelectorAll('tr').forEach(row => {
                        if (row.children[columnIndex]) {
                            row.children[columnIndex].remove();
                        }
                    });
                }
            }
        }
        
        // ‚úÖ –û—á–∏—â–∞–µ–º localStorage –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ API
        cleanupLocalStorage(type, id);
        updateCounts();
        checkAndShowEmptyState();
        
        showNotification(`–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (–±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)`, 'warning');
    }
}

// ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—á–∏—â–µ–Ω–∏–µ localStorage
function cleanupLocalStorage(type, id) {
    if (type === 'properties') {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è properties
        ['comparisons', 'comparison_properties', 'property_comparisons'].forEach(key => {
            const items = JSON.parse(localStorage.getItem(key) || '[]');
            const filtered = items.filter(item => item != id);
            localStorage.setItem(key, JSON.stringify(filtered));
        });
        
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º comparison-data –æ–±—ä–µ–∫—Ç
        const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
        if (comparisonData.properties) {
            comparisonData.properties = comparisonData.properties.filter(item => item != id);
            localStorage.setItem('comparison-data', JSON.stringify(comparisonData));
        }
    } else {
        // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è complexes
        ['comparison_complexes', 'complex_comparisons', 'complexes'].forEach(key => {
            const items = JSON.parse(localStorage.getItem(key) || '[]');
            const filtered = items.filter(item => item != id);
            localStorage.setItem(key, JSON.stringify(filtered));
        });
    }
}

// ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function checkAndShowEmptyState() {
    const propertiesItems = JSON.parse(localStorage.getItem('comparisons') || '[]');
    const complexesItems = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
    
    if (propertiesItems.length === 0 && complexesItems.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        document.querySelectorAll('.comparison-content').forEach(content => {
            content.classList.add('hidden');
        });
    }
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û—á–∏—Å—Ç–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–∏
async function clearAllComparisons() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è?')) {
        try {
            // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ endpoint
            const isManager = Boolean(window.manager_authenticated);
            const endpoint = isManager ? '/api/manager/comparison/clear' : '/api/comparison/clear';
            
            console.log(`üîÑ Clearing comparisons for ${isManager ? 'manager' : 'user'} via ${endpoint}`);
            
            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º API endpoint –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ë–î
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                credentials: 'same-origin'
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Comparisons cleared from database');
                
                // ‚úÖ –û—á–∏—â–∞–µ–º localStorage –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ API –≤—ã–∑–æ–≤–∞
                localStorage.removeItem('comparison_properties');
                localStorage.removeItem('comparisons');
                localStorage.removeItem('comparison_complexes');
                
                // Update comparison counts in header if exists
                const headerCountProperties = document.getElementById('comparison-count-properties');
                const headerCountComplexes = document.getElementById('comparison-count-complexes');
                if (headerCountProperties) headerCountProperties.textContent = '0';
                if (headerCountComplexes) headerCountComplexes.textContent = '0';
                
                loadComparisons();
                showNotification('–í—Å–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã', 'success');
            } else {
                showNotification(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π', 'error');
            }
            
        } catch (error) {
            console.error('Error clearing comparisons:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            
            // ‚úÖ Fallback –∫ localStorage —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏
            console.log('Using localStorage fallback for clearing');
            localStorage.removeItem('comparison_properties');
            localStorage.removeItem('comparisons');
            localStorage.removeItem('comparison_complexes');
            
            loadComparisons();
            showNotification('–°—Ä–∞–≤–Ω–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ (–±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)', 'warning');
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

function updateCounts() {
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞
    let propertiesCount = 0;
    let complexesCount = 0;
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
    if (window.lastComparisonData && window.lastComparisonData.comparison) {
        propertiesCount = window.lastComparisonData.comparison.properties_count || 0;
        complexesCount = window.lastComparisonData.comparison.complexes_count || 0;
        console.log('‚úÖ Using API data for counts:', { propertiesCount, complexesCount });
    } else {
        // Fallback –∫ localStorage —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π
        let propertiesItems = JSON.parse(localStorage.getItem('comparisons') || '[]');
        if (propertiesItems.length === 0) {
            const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
            propertiesItems = comparisonData.properties || [];
        }
        if (propertiesItems.length === 0) {
            propertiesItems = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
        }
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è localStorage –¥–∞–Ω–Ω—ã—Ö
        const uniqueProperties = [...new Set(propertiesItems)];
        const uniqueComplexes = [...new Set(JSON.parse(localStorage.getItem('comparison_complexes') || '[]'))];
        
        propertiesCount = uniqueProperties.length;
        complexesCount = uniqueComplexes.length;
        console.log('‚ö†Ô∏è Using localStorage fallback with deduplication:', { propertiesCount, complexesCount });
    }
    
    console.log('Updating counts:', { propertiesCount, complexesCount });
    
    const propertiesCountEl = document.getElementById('properties-count');
    const complexesCountEl = document.getElementById('complexes-count');
    
    if (propertiesCountEl) propertiesCountEl.textContent = propertiesCount;
    if (complexesCountEl) complexesCountEl.textContent = complexesCount;
    
    // Show empty state if no items
    if (propertiesCount === 0 && complexesCount === 0) {
        console.log('Showing empty state');
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('properties-comparison').classList.add('hidden');
        document.getElementById('complexes-comparison').classList.add('hidden');
    } else {
        console.log('Hiding empty state, showing comparisons');
        document.getElementById('empty-state').classList.add('hidden');
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
        if (propertiesCount > 0) {
            document.getElementById('properties-comparison').classList.remove('hidden');
        }
        if (complexesCount > 0) {
            document.getElementById('complexes-comparison').classList.remove('hidden');
        }
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–∞–± —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç–∞–± –ø—É—Å—Ç–æ–π
        const activeTab = document.querySelector('.comparison-tab.active');
        const currentTabType = activeTab ? (activeTab.id === 'tab-properties' ? 'properties' : 'complexes') : null;
        const currentTabCount = currentTabType === 'properties' ? propertiesCount : complexesCount;
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–∞–± —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç–∞–± –ø—É—Å—Ç–æ–π –∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –¥—Ä—É–≥–æ–º —Ç–∞–±–µ
        if (currentTabCount === 0) {
            if (propertiesCount > 0) {
                switchTab('properties');
            } else if (complexesCount > 0) {
                switchTab('complexes');
            }
        }
    }
}

// ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑ API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
async function loadComparison(type) {
    console.log(`üîç loadComparison called for type: ${type}`);
    
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
        const isManager = Boolean(window.manager_authenticated);
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º API endpoint'—ã –≤–º–µ—Å—Ç–æ localStorage
        const endpoint = isManager ? '/api/manager/comparison/load' : `/api/comparison/load`;
        
        const response = await fetch(endpoint);
        const result = await response.json();
        
        console.log(`üîç Comparison API response for ${type}:`, result);
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ API –≤ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        if (!window.lastComparisonData) window.lastComparisonData = {};
        if (result.complexes) window.lastComparisonData.complexes = result.complexes;
        if (result.properties) window.lastComparisonData.properties = result.properties;
        if (result.comparison) window.lastComparisonData.comparison = result.comparison;
        
        if (result.success) {
            if (type === 'properties') {
                if (result.properties && result.properties.length > 0) {
                    const propertyIds = result.properties.map(prop => prop.property_id);
                    await buildPropertiesComparison(propertyIds, document.getElementById('properties-grid'));
                } else {
                    showEmptyState('properties');
                }
            } else if (type === 'complexes') {
                if (result.complexes && result.complexes.length > 0) {
                    console.log('üöÄüöÄüöÄ –í–ï–†–°–ò–Ø 2.1 ‚Äî complexes rendered from API:', result.complexes.length);
                    
                    // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ API –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const normalizedComplexes = result.complexes.map(complex => ({
                        id: complex.complex_id,
                        name: complex.complex_name || `–ñ–ö ${complex.complex_id}`,
                        developer: complex.developer_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        completion_date: complex.completion_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        price_from: complex.min_price || 0,
                        price_to: complex.max_price || 0,
                        district: complex.district || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        status: complex.status || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        image: complex.photo || '/static/images/no-image.jpg',
                        complex_class: complex.complex_class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        building_class: complex.complex_class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        buildings_count: complex.buildings_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        apartments_count: complex.apartments_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        floors_max: complex.floors_max || complex.object_max_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        floors_min: complex.floors_min || complex.object_min_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        cashback_percent: complex.cashback_percent || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
                    }));
                    
                    await buildComplexesComparisonWithDataFixed(normalizedComplexes, document.getElementById('complexes-grid'));
                } else {
                    showEmptyState('complexes');
                }
            }
        } else {
            console.warn(`No comparison data found for ${type}, using localStorage fallback`);
            await loadComparisonFromLocalStorage(type);
        }
    } catch (error) {
        console.error(`Error loading comparison data for ${type}:`, error);
        console.log(`Using localStorage fallback for ${type}`);
        await loadComparisonFromLocalStorage(type);
    }
}

// ‚úÖ Fallback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è localStorage (–∫–æ–≥–¥–∞ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
async function loadComparisonFromLocalStorage(type) {
    let comparisonItems;
    
    if (type === 'properties') {
        // Use all localStorage formats for properties
        comparisonItems = JSON.parse(localStorage.getItem('comparisons') || '[]');
        if (comparisonItems.length === 0) {
            const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
            comparisonItems = comparisonData.properties || [];
        }
        if (comparisonItems.length === 0) {
            comparisonItems = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
        }
        
        if (comparisonItems.length > 0) {
            await buildPropertiesComparison(comparisonItems, document.getElementById('properties-grid'));
        } else {
            showEmptyState('properties');
        }
    } else if (type === 'complexes') {
        comparisonItems = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        
        if (comparisonItems.length > 0) {
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage fallback —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            // –ù–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ localStorage –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API response –Ω–∞–ø—Ä—è–º—É—é
            if (window.lastComparisonData?.complexes && window.lastComparisonData.complexes.length > 0) {
                console.log('üöÄüöÄüöÄ –í–ï–†–°–ò–Ø 2.1 - Using comparison API data for complexes');
                
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ API –≤ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è  
                const complexesForDisplay = window.lastComparisonData.complexes.map(complex => ({
                    id: complex.complex_id,
                    name: complex.complex_name || `–ñ–ö ${complex.complex_id}`,
                    developer: complex.developer_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    completion_date: complex.completion_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    price_from: complex.min_price || 0,
                    price_to: complex.max_price || 0,
                    district: complex.district || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    status: complex.status || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    image: complex.photo || '/static/images/no-image.jpg',
                    complex_class: complex.complex_class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
                }));
                
                // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ comparisonItems
                const filteredComplexes = complexesForDisplay.filter(c => comparisonItems.includes(c.id));
                console.log('üöÄüöÄüöÄ –í–ï–†–°–ò–Ø 2.1 - –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∫–æ–º–ø–ª–µ–∫—Å–æ–≤ localStorage:', filteredComplexes.length);
                buildComplexesComparisonWithDataFixed(filteredComplexes, document.getElementById('complexes-grid'));
            } else {
                console.log('üöÄüöÄüöÄ –í–ï–†–°–ò–Ø 2.1 - localStorage fallback with API data');
                // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–∞–∂–µ –≤ localStorage fallback –∏—Å–ø–æ–ª—å–∑—É–µ–º API –¥–∞–Ω–Ω—ã–µ
                if (window.lastComparisonData?.complexes && window.lastComparisonData.complexes.length > 0) {
                    const normalizedComplexes = window.lastComparisonData.complexes.map(complex => ({
                        id: complex.complex_id,
                        name: complex.complex_name || `–ñ–ö ${complex.complex_id}`,
                        developer: complex.developer_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        completion_date: complex.completion_date || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        price_from: complex.min_price || 0,
                        price_to: complex.max_price || 0,
                        district: complex.district || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        status: complex.status || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        image: complex.photo || '/static/images/no-image.jpg',
                        complex_class: complex.complex_class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        building_class: complex.complex_class || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        buildings_count: complex.buildings_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        apartments_count: complex.apartments_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        floors_max: complex.floors_max || complex.object_max_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        floors_min: complex.floors_min || complex.object_min_floor || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        cashback_percent: complex.cashback_percent || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
                    }));
                    // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ comparisonItems
                    const filteredComplexes = normalizedComplexes.filter(c => comparisonItems.includes(c.id));
                    console.log('üöÄüöÄüöÄ –í–ï–†–°–ò–Ø 2.1 - –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ localStorage final:', filteredComplexes.length);
                    buildComplexesComparisonWithDataFixed(filteredComplexes, document.getElementById('complexes-grid'));
                } else {
                    console.log('üöÄüöÄüöÄ –í–ï–†–°–ò–Ø 2.1 - Final localStorage fallback without old function');
                    // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–∞–∂–µ –≤ localStorage fallback
                    if (window.complexesData && window.complexesData.length > 0) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.complexesData –¥–ª—è localStorage fallback
                        const filteredComplexes = window.complexesData.filter(c => comparisonItems.includes(c.id));
                        buildComplexesComparisonWithDataFixed(filteredComplexes, document.getElementById('complexes-grid'));
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
                        showEmptyState('complexes');
                    }
                }
            }
        } else {
            showEmptyState('complexes');
        }
    }
}

// ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (properties –∏ complexes)
function loadComparisons() {
    loadComparison('properties');
    loadComparison('complexes');
}

// Function to handle loadComparisonContent calls (compatibility with dashboard)
function loadComparisonContent() {
    console.log('loadComparisonContent called - refreshing comparison data');
    
    // Update counts first
    updateCounts();
    
    // Get current active tab
    const activeTab = document.querySelector('.comparison-tab.active');
    const currentType = activeTab ? (activeTab.id === 'tab-properties' ? 'properties' : 'complexes') : 'properties';
    
    // Reload current tab
    loadComparison(currentType);
    
    console.log('Comparison content reloaded for type:', currentType);
}

// ‚úÖ NEW FUNCTION: Show loading state while data is being loaded  
function showLoadingState(grid, type) {
    if (grid) {
        grid.innerHTML = `
            <div class="text-center py-16">
                <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${type === 'properties' ? '–∫–≤–∞—Ä—Ç–∏—Ä' : '–ñ–ö'}...</p>
            </div>
        `;
    }
}
</script>
{% endblock %}